# =============================================================================
# EJEMPLO: Rate Limiting
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rate-limit-ingress
  annotations:
    # Límite de requests por segundo por IP
    nginx.ingress.kubernetes.io/limit-rps: "10"
    
    # Burst multiplier (permite picos temporales)
    # Con rps=10 y burst=5 → permite hasta 50 rps en burst
    nginx.ingress.kubernetes.io/limit-burst-multiplier: "5"
    
    # Límite de conexiones simultáneas por IP
    nginx.ingress.kubernetes.io/limit-connections: "10"
    
    # Whitelist de IPs (excluidas del rate limiting)
    nginx.ingress.kubernetes.io/limit-whitelist: "10.0.0.0/8,192.168.1.0/24"
spec:
  ingressClassName: nginx
  rules:
  - host: api.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 8080

# COMPORTAMIENTO:
# - Peticiones normales (≤10 rps): 200 OK
# - Exceso hasta burst: 200 OK (se quedan en cola)
# - Exceso sobre burst: 503 Service Temporarily Unavailable

# VERIFICACIÓN:
# # Generar tráfico (instalar: apt-get install apache2-utils)
# ab -n 100 -c 10 http://api.example.com/
# 
# # Ver responses con status 503
# for i in {1..20}; do curl -s -o /dev/null -w "%{http_code}\n" http://api.example.com/; done
