# =============================================================================
# EJEMPLO: Ingress Production-Ready (Multi-App)
# =============================================================================
# DESCRIPCIÓN:
#   Configuración completa para producción con múltiples aplicaciones,
#   TLS, seguridad, monitoreo y best practices.
#
# APLICACIONES:
#   - Frontend: app.example.com
#   - API Backend: api.example.com
#   - Admin Panel: admin.example.com (con auth)
#   - Docs: docs.example.com
# =============================================================================

---
# Secrets TLS (uno por dominio o wildcard)
apiVersion: v1
kind: Secret
metadata:
  name: production-tls
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTi...  # Certificado de CA confiable (Let's Encrypt)
  tls.key: LS0tLS1CRUdJTi...  # Clave privada

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: production-multi-app-ingress
  annotations:
    # =========================================================================
    # SEGURIDAD
    # =========================================================================
    # Forzar HTTPS
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    
    # HSTS (HTTP Strict Transport Security)
    nginx.ingress.kubernetes.io/hsts: "true"
    nginx.ingress.kubernetes.io/hsts-max-age: "31536000"  # 1 año
    nginx.ingress.kubernetes.io/hsts-include-subdomains: "true"
    
    # =========================================================================
    # RENDIMIENTO
    # =========================================================================
    # Compresión gzip
    nginx.ingress.kubernetes.io/enable-gzip: "true"
    nginx.ingress.kubernetes.io/gzip-types: "text/plain text/css application/json application/javascript text/xml application/xml"
    
    # Proxy buffers
    nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "4"
    
    # Timeouts
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    
    # =========================================================================
    # MONITOREO Y OBSERVABILIDAD
    # =========================================================================
    # Métricas de Prometheus
    nginx.ingress.kubernetes.io/enable-metrics: "true"
    
    # Request ID para tracing
    nginx.ingress.kubernetes.io/enable-request-id: "true"
    
    # =========================================================================
    # SEGURIDAD ADICIONAL
    # =========================================================================
    # Rate limiting global
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"
    
    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
spec:
  ingressClassName: nginx
  
  # =========================================================================
  # TLS CONFIGURATION
  # =========================================================================
  tls:
  - hosts:
    - app.example.com
    - api.example.com
    - admin.example.com
    - docs.example.com
    secretName: production-tls
  
  # =========================================================================
  # ROUTING RULES
  # =========================================================================
  rules:
  # Frontend Application
  - host: app.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-service
            port:
              number: 80
  
  # API Backend
  - host: api.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 8080
  
  # Admin Panel (requiere autenticación)
  - host: admin.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: admin-service
            port:
              number: 8080
  
  # Documentation
  - host: docs.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: docs-service
            port:
              number: 80

# =============================================================================
# CHECKLIST DE PRODUCCIÓN:
# =============================================================================
# 
# ✅ Seguridad:
#   - [ ] TLS con certificado de CA confiable (Let's Encrypt)
#   - [ ] Force SSL redirect
#   - [ ] HSTS enabled
#   - [ ] Security headers configurados
#   - [ ] Rate limiting activo
#   - [ ] IP whitelist para admin (si aplica)
# 
# ✅ Alta Disponibilidad:
#   - [ ] Múltiples réplicas de ingress controller (min 3)
#   - [ ] PodDisruptionBudget configurado
#   - [ ] Resource requests/limits definidos
#   - [ ] HPA configurado
# 
# ✅ Monitoreo:
#   - [ ] Métricas de Prometheus habilitadas
#   - [ ] Dashboards de Grafana creados
#   - [ ] Alertas configuradas (cert expiration, 5xx errors)
#   - [ ] Request tracing habilitado
# 
# ✅ Rendimiento:
#   - [ ] Gzip compression habilitada
#   - [ ] Proxy buffers optimizados
#   - [ ] Timeouts apropiados
#   - [ ] Connection pooling configurado
# 
# ✅ Gestión:
#   - [ ] IngressClass definida
#   - [ ] Anotaciones documentadas
#   - [ ] GitOps / Control de versiones
#   - [ ] Rollback plan definido
# =============================================================================
