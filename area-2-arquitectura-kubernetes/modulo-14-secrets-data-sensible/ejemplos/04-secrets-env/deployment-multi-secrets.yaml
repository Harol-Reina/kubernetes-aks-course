# Deployment que combina múltiples Secrets y ConfigMaps como variables de entorno
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-public-config
data:
  LOG_LEVEL: "info"
  APP_ENV: "production"
  FEATURE_FLAG_NEW_UI: "true"

---
apiVersion: v1
kind: Secret
metadata:
  name: db-secret
type: Opaque
stringData:
  DB_USER: "app_user"
  DB_PASSWORD: "SecureDBPass123!"
  DB_HOST: "postgres.production.svc.cluster.local"

---
apiVersion: v1
kind: Secret
metadata:
  name: api-secret
type: Opaque
stringData:
  API_KEY: "sk_live_api_key_12345"
  API_SECRET: "api_secret_xyz789"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-deployment
  labels:
    app: myapp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: app
        image: busybox
        command:
        - sh
        - -c
        - |
          echo "=== Application Configuration ==="
          echo "Environment: $APP_ENV"
          echo "Log Level: $LOG_LEVEL"
          echo "Feature Flag: $FEATURE_FLAG_NEW_UI"
          echo ""
          echo "=== Database Configuration ==="
          echo "DB Host: $DB_HOST"
          echo "DB User: $DB_USER"
          echo "DB Password: [REDACTED]"
          echo ""
          echo "=== API Configuration ==="
          echo "API Key: ${API_KEY:0:10}..."
          echo "API Secret: [REDACTED]"
          echo ""
          echo "=== Custom Variables ==="
          echo "App Name: $APP_NAME"
          echo "Version: $APP_VERSION"
          echo ""
          echo "Application started. Sleeping..."
          sleep 3600
        
        # Combinar múltiples fuentes de configuración
        env:
        # Variables estáticas
        - name: APP_NAME
          value: "MyApplication"
        - name: APP_VERSION
          value: "1.0.0"
        
        # Variables individuales desde ConfigMap
        - name: CUSTOM_LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: app-public-config
              key: LOG_LEVEL
        
        # Variables individuales desde Secret
        - name: PRIMARY_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: DB_PASSWORD
        
        # Importar TODO el ConfigMap
        envFrom:
        - configMapRef:
            name: app-public-config
        
        # Importar TODO el primer Secret
        - secretRef:
            name: db-secret
        
        # Importar TODO el segundo Secret
        - secretRef:
            name: api-secret

---
# Comandos de verificación:
# kubectl apply -f deployment-multi-secrets.yaml
# kubectl get pods -l app=myapp
# kubectl logs -l app=myapp --tail=20
# kubectl exec -it deployment/myapp-deployment -- env | sort
#
# Verificar variables específicas:
# kubectl exec deployment/myapp-deployment -- sh -c 'echo $DB_PASSWORD'
# kubectl exec deployment/myapp-deployment -- sh -c 'echo $API_KEY'
#
# Limpiar:
# kubectl delete deployment myapp-deployment
# kubectl delete secret db-secret api-secret
# kubectl delete configmap app-public-config
