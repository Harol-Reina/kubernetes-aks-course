# Deployment con Nginx que usa Secret montado como archivo de configuración
# Demuestra actualización automática cuando el Secret cambia
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  nginx.conf: |
    events {
        worker_connections 1024;
    }
    http {
        server {
            listen 80;
            server_name localhost;
            
            location / {
                root /usr/share/nginx/html;
                index index.html;
            }
            
            location /health {
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }
        }
    }

---
apiVersion: v1
kind: Secret
metadata:
  name: nginx-htpasswd
type: Opaque
stringData:
  # Credenciales para autenticación básica HTTP
  # Generado con: htpasswd -nb admin SecretPass
  .htpasswd: |
    admin:$apr1$xyz$AbCdEfGhIjKlMnOpQrStUv

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-with-secrets
  labels:
    app: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
          name: http
        
        volumeMounts:
        # Montar configuración pública (ConfigMap)
        - name: config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
          readOnly: true
        
        # Montar archivo de contraseñas (Secret)
        - name: htpasswd
          mountPath: /etc/nginx/.htpasswd
          subPath: .htpasswd
          readOnly: true
        
        # Actualización automática de Secret (sin subPath)
        - name: credentials-auto-update
          mountPath: /etc/nginx/secrets
          readOnly: true
      
      volumes:
      # ConfigMap con configuración de Nginx
      - name: config
        configMap:
          name: nginx-config
      
      # Secret con archivo .htpasswd (subPath = NO auto-update)
      - name: htpasswd
        secret:
          secretName: nginx-htpasswd
          defaultMode: 0400
      
      # Secret montado sin subPath = SÍ auto-update (~1 min)
      - name: credentials-auto-update
        secret:
          secretName: nginx-htpasswd
          defaultMode: 0400

---
# Servicio para exponer Nginx
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  selector:
    app: nginx
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP

---
# Comandos de verificación:
# kubectl apply -f deployment-nginx-secrets.yaml
# kubectl get pods -l app=nginx
# 
# Verificar archivos montados:
# kubectl exec deployment/nginx-with-secrets -- ls -la /etc/nginx/
# kubectl exec deployment/nginx-with-secrets -- cat /etc/nginx/.htpasswd
# kubectl exec deployment/nginx-with-secrets -- cat /etc/nginx/secrets/.htpasswd
#
# Probar actualización automática:
# 1. Actualizar el Secret:
# kubectl create secret generic nginx-htpasswd \
#   --from-literal=.htpasswd='newuser:$apr1$xyz$NewPasswordHash' \
#   --dry-run=client -o yaml | kubectl apply -f -
#
# 2. Esperar ~1 minuto y verificar:
# kubectl exec deployment/nginx-with-secrets -- cat /etc/nginx/secrets/.htpasswd
# (Debería mostrar el nuevo contenido)
#
# kubectl exec deployment/nginx-with-secrets -- cat /etc/nginx/.htpasswd
# (NO cambiará porque usa subPath)
#
# Limpiar:
# kubectl delete deployment nginx-with-secrets
# kubectl delete service nginx-service
# kubectl delete secret nginx-htpasswd
# kubectl delete configmap nginx-config
