# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# EJEMPLO 4: Multi-Container Pod - Full Stack
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# DESCRIPCIÃ“N:
#   Pod completo con init container, main app, y mÃºltiples sidecars:
#   - Init: Setup de configuraciÃ³n
#   - Main: Web application (nginx)
#   - Sidecar 1: Log processor
#   - Sidecar 2: Metrics exporter
#
# CASO DE USO:
#   - AplicaciÃ³n completa con observabilidad
#   - Demostrar todos los patrones juntos
#   - Production-ready Pod configuration
#
# APLICAR:
#   kubectl apply -f multi-container-full.yaml
#
# VERIFICAR:
#   kubectl get pod fullstack-app
#   kubectl logs fullstack-app -c <container-name>
#   kubectl exec fullstack-app -c web -- curl localhost
#   kubectl exec fullstack-app -c metrics -- curl localhost:9113/metrics
#
# LIMPIAR:
#   kubectl delete -f multi-container-full.yaml
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

apiVersion: v1
kind: Pod
metadata:
  name: fullstack-app
  labels:
    app: fullstack
    tier: web
    observability: enabled
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9113"
    prometheus.io/path: "/metrics"
    description: "Full-stack multi-container pod con observabilidad completa"
spec:
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # INIT CONTAINERS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  initContainers:
  
  # Init 1: Generar configuraciÃ³n dinÃ¡mica
  - name: config-generator
    image: busybox:1.35
    command:
    - sh
    - -c
    - |
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "Init 1: Generando configuraciÃ³n..."
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      # Generar nginx.conf
      cat > /config/nginx.conf <<'EOF'
      events {
          worker_connections 1024;
      }
      
      http {
          include /etc/nginx/mime.types;
          default_type application/octet-stream;
          
          log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent"';
          
          access_log /var/log/nginx/access.log main;
          error_log /var/log/nginx/error.log warn;
          
          server {
              listen 80;
              server_name localhost;
              
              location / {
                  root /usr/share/nginx/html;
                  index index.html;
              }
              
              # Stub status para metrics exporter
              location /stub_status {
                  stub_status on;
                  access_log off;
                  allow 127.0.0.1;
                  deny all;
              }
              
              # Health check endpoint
              location /health {
                  access_log off;
                  return 200 "healthy\n";
                  add_header Content-Type text/plain;
              }
          }
      }
      EOF
      
      # Generar index.html personalizado
      cat > /html/index.html <<EOF
      <!DOCTYPE html>
      <html>
      <head>
          <title>Fullstack Multi-Container App</title>
          <style>
              body { font-family: Arial; margin: 40px; }
              .info { background: #e3f2fd; padding: 20px; border-radius: 5px; }
          </style>
      </head>
      <body>
          <h1>ğŸš€ Fullstack Multi-Container Pod</h1>
          <div class="info">
              <h2>Pod Info:</h2>
              <p><strong>Hostname:</strong> $(hostname)</p>
              <p><strong>Generated at:</strong> $(date)</p>
              <p><strong>Containers:</strong></p>
              <ul>
                  <li>Init: config-generator, wait-for-health</li>
                  <li>Main: web (nginx)</li>
                  <li>Sidecar: log-processor, metrics-exporter</li>
              </ul>
          </div>
          <h3>Endpoints:</h3>
          <ul>
              <li><a href="/">/</a> - Esta pÃ¡gina</li>
              <li><a href="/health">/health</a> - Health check</li>
              <li>/stub_status - Nginx metrics (localhost only)</li>
              <li>:9113/metrics - Prometheus metrics</li>
          </ul>
      </body>
      </html>
      EOF
      
      echo "âœ… Config generada exitosamente"
      ls -la /config/
      ls -la /html/
    
    volumeMounts:
    - name: nginx-config
      mountPath: /config
    - name: html
      mountPath: /html
    
    resources:
      requests:
        cpu: "100m"
        memory: "64Mi"
  
  # Init 2: Wait for health (simulado)
  - name: wait-for-health
    image: busybox:1.35
    command:
    - sh
    - -c
    - |
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "Init 2: Verificando dependencias..."
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      # Simular health check de servicios externos
      echo "Verificando servicio externo..."
      sleep 3
      
      echo "âœ… Todas las dependencias estÃ¡n listas"
    
    resources:
      requests:
        cpu: "50m"
        memory: "32Mi"
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # MAIN CONTAINER: Web Application
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  containers:
  
  - name: web
    image: nginx:1.25-alpine
    ports:
    - containerPort: 80
      name: http
      protocol: TCP
    
    # Usar config generada por init container
    volumeMounts:
    - name: nginx-config
      mountPath: /etc/nginx/nginx.conf
      subPath: nginx.conf
      readOnly: true
    - name: html
      mountPath: /usr/share/nginx/html
      readOnly: true
    - name: logs
      mountPath: /var/log/nginx
    
    # Health checks
    livenessProbe:
      httpGet:
        path: /health
        port: 80
      initialDelaySeconds: 10
      periodSeconds: 30
    
    readinessProbe:
      httpGet:
        path: /health
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 10
    
    resources:
      requests:
        cpu: "250m"
        memory: "256Mi"
      limits:
        cpu: "500m"
        memory: "512Mi"
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SIDECAR 1: Log Processor
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - name: log-processor
    image: busybox:1.35
    command:
    - sh
    - -c
    - |
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "Log Processor iniciado"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      # Esperar a que nginx cree logs
      while [ ! -f /var/log/nginx/access.log ]; do
        sleep 2
      done
      
      echo "âœ… Logs detectados, procesando..."
      
      # Procesar logs en tiempo real
      tail -f /var/log/nginx/access.log | while read line; do
        # Contar requests por segundo
        echo "[LOG_PROCESSOR] $(date '+%H:%M:%S') - Request: $line"
        
        # En producciÃ³n: enviar a Elasticsearch, Splunk, etc.
      done
    
    volumeMounts:
    - name: logs
      mountPath: /var/log/nginx
      readOnly: true
    
    resources:
      requests:
        cpu: "50m"
        memory: "64Mi"
      limits:
        cpu: "100m"
        memory: "128Mi"
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SIDECAR 2: Metrics Exporter
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - name: metrics-exporter
    image: nginx/nginx-prometheus-exporter:0.11
    args:
    - -nginx.scrape-uri=http://localhost:80/stub_status
    
    ports:
    - containerPort: 9113
      name: metrics
      protocol: TCP
    
    # Health check para exporter
    livenessProbe:
      httpGet:
        path: /metrics
        port: 9113
      initialDelaySeconds: 10
      periodSeconds: 30
    
    resources:
      requests:
        cpu: "50m"
        memory: "64Mi"
      limits:
        cpu: "100m"
        memory: "128Mi"
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # VOLUMES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  volumes:
  
  # Config generada por init container
  - name: nginx-config
    emptyDir: {}
  
  # HTML content
  - name: html
    emptyDir: {}
  
  # Logs compartidos
  - name: logs
    emptyDir:
      sizeLimit: "1Gi"  # Limitar tamaÃ±o de logs
  
  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 101  # nginx user
    fsGroup: 101
  
  restartPolicy: Always

---

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SERVICE para exponer el Pod
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

apiVersion: v1
kind: Service
metadata:
  name: fullstack-app-service
  labels:
    app: fullstack
spec:
  selector:
    app: fullstack
  ports:
  - name: http
    protocol: TCP
    port: 80
    targetPort: http
  - name: metrics
    protocol: TCP
    port: 9113
    targetPort: metrics
  type: ClusterIP

---

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TESTING COMPLETO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# 1. Aplicar todo:
#    kubectl apply -f multi-container-full.yaml
#
# 2. Ver progreso de init containers:
#    kubectl get pod fullstack-app -w
#    # Init:0/2 â†’ Init:1/2 â†’ Init:2/2 â†’ Running
#
# 3. Ver logs de cada init container:
#    kubectl logs fullstack-app -c config-generator
#    kubectl logs fullstack-app -c wait-for-health
#
# 4. Ver logs de containers principales:
#    kubectl logs fullstack-app -c web
#    kubectl logs fullstack-app -c log-processor
#    kubectl logs fullstack-app -c metrics-exporter
#
# 5. Ver TODOS los logs (stern):
#    stern fullstack-app
#
# 6. Probar la aplicaciÃ³n:
#    kubectl port-forward fullstack-app 8080:80
#    curl http://localhost:8080
#    curl http://localhost:8080/health
#
# 7. Ver mÃ©tricas de Prometheus:
#    kubectl port-forward fullstack-app 9113:9113
#    curl http://localhost:9113/metrics
#
# 8. Generar trÃ¡fico y ver logs procesÃ¡ndose:
#    # Terminal 1:
#    kubectl port-forward fullstack-app 8080:80
#    while true; do curl -s http://localhost:8080 > /dev/null; sleep 1; done
#    
#    # Terminal 2:
#    kubectl logs -f fullstack-app -c log-processor
#
# 9. Verificar recursos por container:
#    kubectl top pod fullstack-app --containers
#
# 10. Ver configuraciÃ³n completa:
#     kubectl get pod fullstack-app -o yaml
#
# 11. Verificar volumes compartidos:
#     # Config volume
#     kubectl exec fullstack-app -c web -- cat /etc/nginx/nginx.conf
#     
#     # HTML volume
#     kubectl exec fullstack-app -c web -- cat /usr/share/nginx/html/index.html
#     
#     # Logs volume
#     kubectl exec fullstack-app -c web -- ls -la /var/log/nginx
#     kubectl exec fullstack-app -c log-processor -- ls -la /var/log/nginx
#
# 12. Verificar comunicaciÃ³n localhost:
#     # Web â†’ Metrics exporter
#     kubectl exec fullstack-app -c web -- wget -qO- http://localhost:9113/metrics
#     
#     # Metrics exporter â†’ Web
#     kubectl exec fullstack-app -c metrics-exporter -- wget -qO- http://localhost:80/health
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RECURSOS TOTALES DEL POD
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CPU Requests:  100m + 50m + 250m + 50m + 50m = 500m (0.5 cores)
# CPU Limits:    -    + -    + 500m + 100m + 100m = 700m (0.7 cores)
# 
# Memory Requests: 64Mi + 32Mi + 256Mi + 64Mi + 64Mi = 480Mi
# Memory Limits:   -    + -    + 512Mi + 128Mi + 128Mi = 768Mi
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONCEPTOS DEMOSTRADOS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âœ… Init containers secuenciales (config-generator â†’ wait-for-health)
# âœ… Main container con probes
# âœ… Multiple sidecars (logging + monitoring)
# âœ… Shared volumes (config, html, logs)
# âœ… Localhost communication (web â†” metrics-exporter)
# âœ… Resource limits por container
# âœ… Security context
# âœ… Health checks
# âœ… Read-only mounts
# âœ… Annotations para Prometheus
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
