# ============================================================================
# API SERVER - CONFIGURACIÓN Y EJEMPLOS
# ============================================================================
# El API Server es el componente central del Control Plane de Kubernetes.
# Este archivo muestra cómo está configurado y cómo interactuar con él.
# ============================================================================

---
# ============================================================================
# CONFIGURACIÓN DEL API SERVER (Static Pod Manifest)
# ============================================================================
# En clusters gestionados por kubeadm, el API Server corre como static pod.
# Ubicación: /etc/kubernetes/manifests/kube-apiserver.yaml
# ============================================================================

apiVersion: v1
kind: Pod
metadata:
  annotations:
    kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint: 192.168.1.10:6443
  name: kube-apiserver
  namespace: kube-system
  labels:
    component: kube-apiserver
    tier: control-plane
spec:
  containers:
  - name: kube-apiserver
    image: registry.k8s.io/kube-apiserver:v1.28.0
    
    # ┌────────────────────────────────────────────────────────────┐
    # │ ARGUMENTOS DE LÍNEA DE COMANDOS                            │
    # │ Configuran el comportamiento del API Server                │
    # └────────────────────────────────────────────────────────────┘
    command:
    - kube-apiserver
    
    # ──────────────────────────────────────────────────────────────
    # CONFIGURACIÓN BÁSICA
    # ──────────────────────────────────────────────────────────────
    - --advertise-address=192.168.1.10
    - --secure-port=6443
    - --allow-privileged=true
    
    # ──────────────────────────────────────────────────────────────
    # AUTENTICACIÓN
    # ──────────────────────────────────────────────────────────────
    - --client-ca-file=/etc/kubernetes/pki/ca.crt
    - --tls-cert-file=/etc/kubernetes/pki/apiserver.crt
    - --tls-private-key-file=/etc/kubernetes/pki/apiserver.key
    
    # Service Account tokens
    - --service-account-key-file=/etc/kubernetes/pki/sa.pub
    - --service-account-signing-key-file=/etc/kubernetes/pki/sa.key
    - --service-account-issuer=https://kubernetes.default.svc.cluster.local
    
    # ──────────────────────────────────────────────────────────────
    # AUTORIZACIÓN (RBAC)
    # ──────────────────────────────────────────────────────────────
    - --authorization-mode=Node,RBAC
    
    # ──────────────────────────────────────────────────────────────
    # CONEXIÓN A ETCD
    # ──────────────────────────────────────────────────────────────
    - --etcd-servers=https://127.0.0.1:2379
    - --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt
    - --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt
    - --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key
    
    # ──────────────────────────────────────────────────────────────
    # ADMISSION CONTROLLERS
    # ──────────────────────────────────────────────────────────────
    - --enable-admission-plugins=NodeRestriction,NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,PodSecurity
    
    # ──────────────────────────────────────────────────────────────
    # NETWORKING
    # ──────────────────────────────────────────────────────────────
    - --service-cluster-ip-range=10.96.0.0/12
    - --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt
    - --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key
    
    # ──────────────────────────────────────────────────────────────
    # KUBELET
    # ──────────────────────────────────────────────────────────────
    - --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt
    - --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key
    - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
    
    # ──────────────────────────────────────────────────────────────
    # RECURSOS Y LÍMITES
    # ──────────────────────────────────────────────────────────────
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 2000m
        memory: 2Gi
    
    # ──────────────────────────────────────────────────────────────
    # HEALTH CHECKS
    # ──────────────────────────────────────────────────────────────
    livenessProbe:
      httpGet:
        path: /livez
        port: 6443
        scheme: HTTPS
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 15
      failureThreshold: 8
    
    readinessProbe:
      httpGet:
        path: /readyz
        port: 6443
        scheme: HTTPS
      periodSeconds: 1
      timeoutSeconds: 15
      failureThreshold: 3
    
    # ──────────────────────────────────────────────────────────────
    # VOLUMENES MONTADOS
    # ──────────────────────────────────────────────────────────────
    volumeMounts:
    - name: ca-certs
      mountPath: /etc/ssl/certs
      readOnly: true
    - name: etc-pki
      mountPath: /etc/pki
      readOnly: true
    - name: k8s-certs
      mountPath: /etc/kubernetes/pki
      readOnly: true
  
  # ──────────────────────────────────────────────────────────────
  # VOLUMENES
  # ──────────────────────────────────────────────────────────────
  volumes:
  - name: ca-certs
    hostPath:
      path: /etc/ssl/certs
      type: DirectoryOrCreate
  - name: etc-pki
    hostPath:
      path: /etc/pki
      type: DirectoryOrCreate
  - name: k8s-certs
    hostPath:
      path: /etc/kubernetes/pki
      type: DirectoryOrCreate
  
  # ──────────────────────────────────────────────────────────────
  # CONFIGURACIÓN DEL POD
  # ──────────────────────────────────────────────────────────────
  hostNetwork: true
  priorityClassName: system-node-critical
  securityContext:
    seccompProfile:
      type: RuntimeDefault

---
# ============================================================================
# EJEMPLO: INTERACCIÓN CON EL API SERVER VIA KUBECTL
# ============================================================================

# Ver información del API Server
# $ kubectl cluster-info
# Kubernetes control plane is running at https://192.168.1.10:6443

# Ver versión del API Server
# $ kubectl version --short
# Client Version: v1.28.0
# Server Version: v1.28.0

# Listar todos los API resources disponibles
# $ kubectl api-resources

# Ver APIs disponibles
# $ kubectl api-versions

---
# ============================================================================
# EJEMPLO: ACCESO DIRECTO AL API SERVER CON curl
# ============================================================================

# Para acceder directamente al API Server (fines educativos):
# 
# 1. Obtener el token de un ServiceAccount
# $ TOKEN=$(kubectl create token default)
# 
# 2. Obtener la CA del cluster
# $ kubectl get secret -o jsonpath="{.items[?(@.type==\"kubernetes.io/service-account-token\")].data['ca\.crt']}" | base64 --decode > ca.crt
# 
# 3. Hacer request al API Server
# $ curl --cacert ca.crt -H "Authorization: Bearer $TOKEN" \
#   https://192.168.1.10:6443/api/v1/namespaces/default/pods

---
# ============================================================================
# EJEMPLO: POD QUE INTERACTÚA CON EL API SERVER
# ============================================================================

apiVersion: v1
kind: Pod
metadata:
  name: api-client-example
  namespace: default
spec:
  serviceAccountName: default
  containers:
  - name: kubectl
    image: bitnami/kubectl
    command:
    - sleep
    - "3600"
    
    # Este pod tiene acceso al API Server mediante:
    # 1. Service Account token automáticamente montado
    # 2. CA certificate del cluster
    # 3. API Server endpoint via environment variables

# Ejecutar dentro del pod:
# $ kubectl exec -it api-client-example -- bash
# $ kubectl get pods
# $ kubectl get nodes

---
# ============================================================================
# EJEMPLO: REQUEST FLOW COMPLETO
# ============================================================================

# Cuando ejecutas: kubectl get pods
# 
# 1. kubectl construye HTTP GET request:
#    GET /api/v1/namespaces/default/pods
#    Headers:
#      Authorization: Bearer <token>
#      User-Agent: kubectl/v1.28.0
# 
# 2. API Server recibe y procesa:
#    a) AUTENTICACIÓN: Verifica token
#    b) AUTORIZACIÓN: Verifica permisos RBAC
#    c) ADMISSION: Plugins de validación
#    d) CONSULTA ETCD: Obtiene datos
#    e) RESPUESTA: Devuelve JSON
# 
# 3. kubectl formatea y muestra resultado

---
# ============================================================================
# COMANDOS ÚTILES PARA INSPECCIONAR EL API SERVER
# ============================================================================

# Ver logs del API Server
# $ kubectl logs -n kube-system kube-apiserver-<node-name>

# Ver métricas del API Server
# $ kubectl top pod -n kube-system kube-apiserver-<node-name>

# Verificar health endpoints
# $ kubectl get --raw /livez?verbose
# $ kubectl get --raw /readyz?verbose
# $ kubectl get --raw /healthz?verbose

# Ver configuración actual
# $ kubectl get pod -n kube-system kube-apiserver-<node-name> -o yaml

# Verificar certificados
# $ kubectl get csr

---
# ============================================================================
# NOTAS DE SEGURIDAD
# ============================================================================
# 
# ✓ El API Server SIEMPRE debe usar TLS (puerto 6443)
# ✓ Nunca exponer el puerto inseguro 8080 (deprecated)
# ✓ Habilitar audit logging en producción
# ✓ Limitar acceso de red al API Server (firewall)
# ✓ Rotar certificados periódicamente
# ✓ Usar RBAC para control de acceso granular
# ✓ Habilitar encryption at rest para Secrets en etcd
# ✓ Configurar admission controllers apropiados
# 
# ============================================================================
