# ============================================================================
# BACKUP Y RESTORE DE etcd
# ============================================================================
# Estrategias y procedimientos para backup/restore del cluster
# ============================================================================

# ğŸ”§ IMPORTANTE - USO EN MINIKUBE:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Este archivo contiene:
# 1. Conceptos de estrategia de backup (âœ… Aplicables a Minikube)
# 2. Procedimientos manuales (âš ï¸ Adaptados en Lab 02 para Minikube)
# 3. CronJob de backup (âš ï¸ Requiere adaptaciÃ³n para Minikube)
# 
# Para hacer backup en Minikube:
# Ver el laboratorio: lab-02-control-plane-practico.md
# SecciÃ³n: Parte 2 - etcd Backup y Restore
# 
# Comandos rÃ¡pidos para backup manual en Minikube:
# $ minikube ssh
# $ docker exec -it $(docker ps -q -f "name=k8s_etcd_etcd") sh
# $ ETCDCTL_API=3 etcdctl snapshot save /tmp/backup.db \
#   --endpoints=https://127.0.0.1:2379 \
#   --cacert=/var/lib/minikube/certs/etcd/ca.crt \
#   --cert=/var/lib/minikube/certs/etcd/server.crt \
#   --key=/var/lib/minikube/certs/etcd/server.key
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

---
# ============================================================================
# ESTRATEGIA DE BACKUP
# ============================================================================

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                  BACKUP STRATEGY                             â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚                                                              â”‚
# â”‚  1. SCHEDULED BACKUPS (Automated)                            â”‚
# â”‚     â€¢ CronJob cada 6 horas                                   â”‚
# â”‚     â€¢ Snapshots guardados en PV o storage externo            â”‚
# â”‚     â€¢ RetenciÃ³n: 7 dÃ­as                                      â”‚
# â”‚                                                              â”‚
# â”‚  2. PRE-UPGRADE BACKUPS (Manual)                             â”‚
# â”‚     â€¢ Antes de actualizar Kubernetes                         â”‚
# â”‚     â€¢ Antes de cambios crÃ­ticos                              â”‚
# â”‚                                                              â”‚
# â”‚  3. DISASTER RECOVERY BACKUPS (External)                     â”‚
# â”‚     â€¢ Copia a cloud storage (S3, GCS, Azure Blob)            â”‚
# â”‚     â€¢ Encriptado                                             â”‚
# â”‚     â€¢ RetenciÃ³n: 30 dÃ­as                                     â”‚
# â”‚                                                              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

---
# ============================================================================
# PROCEDIMIENTO DE BACKUP MANUAL
# ============================================================================
# Para hacer backup manual de etcd, sigue estos pasos:
#
# 1. Configurar variables:
#    BACKUP_DIR="/var/backups/etcd"
#    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
#    BACKUP_FILE="${BACKUP_DIR}/etcd-snapshot-${TIMESTAMP}.db"
#
# 2. Endpoints y certificados:
#    ENDPOINTS="https://192.168.1.20:2379"
#    CACERT="/etc/kubernetes/pki/etcd/ca.crt"
#    CERT="/etc/kubernetes/pki/etcd/server.crt"
#    KEY="/etc/kubernetes/pki/etcd/server.key"
#
# 3. Crear snapshot:
#    $ ETCDCTL_API=3 etcdctl snapshot save ${BACKUP_FILE} \
#      --endpoints=${ENDPOINTS} \
#      --cacert=${CACERT} \
#      --cert=${CERT} \
#      --key=${KEY}
#
# 4. Verificar snapshot:
#    $ ETCDCTL_API=3 etcdctl snapshot status ${BACKUP_FILE} --write-out=table
#
# 5. Limpiar backups antiguos (opcional):
#    $ find ${BACKUP_DIR} -name "etcd-snapshot-*.db" -mtime +7 -delete
#
# Para script automatizado, crear archivo backup-etcd.sh con el procedimiento completo

---
# ============================================================================
# CRONJOB PARA BACKUPS AUTOMÃTICOS
# ============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: etcd-backup-script
  namespace: kube-system
data:
  backup.sh: |
    #!/bin/bash
    set -e
    
    BACKUP_DIR="/backup"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="${BACKUP_DIR}/etcd-snapshot-${TIMESTAMP}.db"
    
    echo "[$(date)] Starting etcd backup..."
    
    # Crear snapshot
    ETCDCTL_API=3 etcdctl snapshot save ${BACKUP_FILE} \
      --endpoints=https://192.168.1.20:2379 \
      --cacert=/etc/kubernetes/pki/etcd/ca.crt \
      --cert=/etc/kubernetes/pki/etcd/server.crt \
      --key=/etc/kubernetes/pki/etcd/server.key
    
    # Verificar
    ETCDCTL_API=3 etcdctl snapshot status ${BACKUP_FILE} --write-out=table
    
    # Comprimir (opcional)
    gzip ${BACKUP_FILE}
    
    # Limpiar antiguos
    find ${BACKUP_DIR} -name "etcd-snapshot-*.db.gz" -mtime +7 -delete
    
    echo "[$(date)] Backup completed: ${BACKUP_FILE}.gz"
    
    # Subir a S3 (opcional)
    # aws s3 cp ${BACKUP_FILE}.gz s3://my-k8s-backups/etcd/

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: etcd-backup
  namespace: kube-system
spec:
  # Cada 6 horas
  schedule: "0 */6 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: etcd-backup
        spec:
          containers:
          - name: backup
            image: registry.k8s.io/etcd:3.5.10-0
            command: ["/bin/sh"]
            args: ["/scripts/backup.sh"]
            volumeMounts:
            - name: etcd-certs
              mountPath: /etc/kubernetes/pki/etcd
              readOnly: true
            - name: backup-volume
              mountPath: /backup
            - name: backup-script
              mountPath: /scripts
            env:
            - name: ETCDCTL_API
              value: "3"
          
          volumes:
          - name: etcd-certs
            hostPath:
              path: /etc/kubernetes/pki/etcd
              type: Directory
          - name: backup-volume
            persistentVolumeClaim:
              claimName: etcd-backup-pvc
          - name: backup-script
            configMap:
              name: etcd-backup-script
              defaultMode: 0755
          
          restartPolicy: OnFailure
          hostNetwork: true
          nodeSelector:
            node-role.kubernetes.io/control-plane: ""
          tolerations:
          - effect: NoSchedule
            key: node-role.kubernetes.io/control-plane

---
# PersistentVolumeClaim para backups
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: etcd-backup-pvc
  namespace: kube-system
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard

---
# ============================================================================
# RESTORE COMPLETO DEL CLUSTER
# ============================================================================

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ESCENARIO: Cluster completamente perdido
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# PASO 1: DETENER TODOS LOS COMPONENTES
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# En TODOS los master nodes:
# $ sudo systemctl stop kubelet
# $ sudo systemctl stop etcd

# Verificar que etcd estÃ¡ detenido
# $ ps aux | grep etcd

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 2: BACKUP DEL ESTADO ACTUAL (por seguridad)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# En cada nodo:
# $ sudo mv /var/lib/etcd /var/lib/etcd.backup-$(date +%Y%m%d_%H%M%S)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 3: RESTORE DESDE SNAPSHOT
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Seleccionar el snapshot mÃ¡s reciente
# $ ls -lth /var/backups/etcd/
# etcd-snapshot-20241111_120000.db.gz  <- MÃ¡s reciente

# Descomprimir si es necesario
# $ gunzip /var/backups/etcd/etcd-snapshot-20241111_120000.db.gz

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# En etcd-1 (192.168.1.20):
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# $ sudo ETCDCTL_API=3 etcdctl snapshot restore \
#   /var/backups/etcd/etcd-snapshot-20241111_120000.db \
#   --name=etcd-1 \
#   --initial-cluster=etcd-1=https://192.168.1.20:2380,etcd-2=https://192.168.1.21:2380,etcd-3=https://192.168.1.22:2380 \
#   --initial-cluster-token=etcd-cluster-1 \
#   --initial-advertise-peer-urls=https://192.168.1.20:2380 \
#   --data-dir=/var/lib/etcd

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# En etcd-2 (192.168.1.21):
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# $ sudo ETCDCTL_API=3 etcdctl snapshot restore \
#   /var/backups/etcd/etcd-snapshot-20241111_120000.db \
#   --name=etcd-2 \
#   --initial-cluster=etcd-1=https://192.168.1.20:2380,etcd-2=https://192.168.1.21:2380,etcd-3=https://192.168.1.22:2380 \
#   --initial-cluster-token=etcd-cluster-1 \
#   --initial-advertise-peer-urls=https://192.168.1.21:2380 \
#   --data-dir=/var/lib/etcd

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# En etcd-3 (192.168.1.22):
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# $ sudo ETCDCTL_API=3 etcdctl snapshot restore \
#   /var/backups/etcd/etcd-snapshot-20241111_120000.db \
#   --name=etcd-3 \
#   --initial-cluster=etcd-1=https://192.168.1.20:2380,etcd-2=https://192.168.1.21:2380,etcd-3=https://192.168.1.22:2380 \
#   --initial-cluster-token=etcd-cluster-1 \
#   --initial-advertise-peer-urls=https://192.168.1.22:2380 \
#   --data-dir=/var/lib/etcd

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 4: AJUSTAR PERMISOS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# En TODOS los nodos:
# $ sudo chown -R etcd:etcd /var/lib/etcd
# $ sudo chmod 700 /var/lib/etcd

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 5: INICIAR etcd
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# En TODOS los nodos (casi simultÃ¡neamente):
# $ sudo systemctl start etcd

# Esperar unos segundos para que el cluster forme quorum

# Verificar logs
# $ sudo journalctl -u etcd -f

# Buscar mensajes de Ã©xito:
# "etcdserver: published local member to cluster"
# "raft.node: elected leader"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 6: VERIFICAR CLUSTER etcd
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# $ ETCDCTL_API=3 etcdctl \
#   --endpoints=https://192.168.1.20:2379 \
#   --cacert=/etc/kubernetes/pki/etcd/ca.crt \
#   --cert=/etc/kubernetes/pki/etcd/server.crt \
#   --key=/etc/kubernetes/pki/etcd/server.key \
#   member list

# $ ETCDCTL_API=3 etcdctl endpoint health --cluster \
#   --endpoints=https://192.168.1.20:2379 \
#   --cacert=/etc/kubernetes/pki/etcd/ca.crt \
#   --cert=/etc/kubernetes/pki/etcd/server.crt \
#   --key=/etc/kubernetes/pki/etcd/server.key

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 7: INICIAR KUBELET
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# En TODOS los master nodes:
# $ sudo systemctl start kubelet

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 8: VERIFICAR CLUSTER KUBERNETES
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# $ kubectl get nodes
# $ kubectl get pods --all-namespaces
# $ kubectl get deployments --all-namespaces

# Verificar que todos los recursos estÃ¡n como antes del desastre

---
# ============================================================================
# RESTORE PARCIAL (SOLO UN NAMESPACE O RECURSO)
# ============================================================================

# Si solo necesitas restaurar objetos especÃ­ficos (no todo el cluster):

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# MÃ‰TODO 1: Usar Velero (herramienta de backup/restore)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Instalar Velero
# $ velero install \
#   --provider aws \
#   --bucket my-k8s-backups \
#   --secret-file ./credentials-velero

# Crear backup de namespace
# $ velero backup create production-backup --include-namespaces production

# Restaurar namespace
# $ velero restore create --from-backup production-backup

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# MÃ‰TODO 2: Backup manual con kubectl
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Backup de namespace completo
# $ kubectl get all -n production -o yaml > production-backup.yaml

# Restore
# $ kubectl apply -f production-backup.yaml

---
# ============================================================================
# TESTING DEL RESTORE
# ============================================================================

# Es CRÃTICO probar el proceso de restore regularmente

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PLAN DE PRUEBAS (cada 3 meses)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# 1. Crear cluster de prueba IDÃ‰NTICO
# 2. Tomar snapshot del cluster producciÃ³n
# 3. Restore en cluster de prueba
# 4. Verificar TODOS los recursos
# 5. Probar aplicaciones
# 6. Documentar tiempo de restore
# 7. Documentar problemas encontrados

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# VERIFICACIÃ“N POST-RESTORE
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# DespuÃ©s de restaurar, verificar:
#
# 1. Nodos: kubectl get nodes
# 2. Componentes del sistema: kubectl get pods -n kube-system
# 3. Namespaces: kubectl get namespaces
# 4. Deployments: kubectl get deployments --all-namespaces
# 5. Services: kubectl get services --all-namespaces
# 6. Volumes: kubectl get pv; kubectl get pvc --all-namespaces
# 7. DNS: kubectl run test-dns --rm -it --image=busybox -- nslookup kubernetes
# 8. etcd health:
#    $ ETCDCTL_API=3 etcdctl endpoint health --cluster \
#      --endpoints=https://192.168.1.20:2379 \
#      --cacert=/etc/kubernetes/pki/etcd/ca.crt \
#      --cert=/etc/kubernetes/pki/etcd/server.crt \
#      --key=/etc/kubernetes/pki/etcd/server.key
#
# Para automatizar, crear script verify-restore.sh

---
# ============================================================================
# NOTAS IMPORTANTES
# ============================================================================
# 
# âœ“ BACKUP REGULAR es OBLIGATORIO en producciÃ³n
# âœ“ Snapshot NO detiene etcd (operaciÃ³n online)
# âœ“ Restore REQUIERE detener cluster COMPLETO
# âœ“ Probar restore REGULARMENTE (cada 3 meses)
# âœ“ Guardar backups FUERA del cluster (S3, GCS, etc.)
# âœ“ Encriptar backups si contienen datos sensibles
# âœ“ RetenciÃ³n mÃ­nima: 7 dÃ­as local, 30 dÃ­as remoto
# âœ“ Documentar RTO (Recovery Time Objective)
# âœ“ Documentar RPO (Recovery Point Objective)
# âœ“ Automatizar proceso de backup (CronJob)
# 
# TIEMPOS TÃPICOS:
# â€¢ Snapshot: 10-30 segundos (depende de DB size)
# â€¢ Restore completo: 5-15 minutos
# â€¢ VerificaciÃ³n: 10-20 minutos
# â€¢ Total RTO: ~30-45 minutos
# 
# RPO:
# â€¢ Backups cada 6 horas = RPO de 6 horas mÃ¡ximo
# â€¢ Backups cada 1 hora = RPO de 1 hora mÃ¡ximo
# 
# DISASTER RECOVERY CHECKLIST:
# â–¡ Snapshots automatizados funcionando
# â–¡ Backups en almacenamiento externo
# â–¡ Procedimiento de restore documentado
# â–¡ Restore probado en Ãºltimos 3 meses
# â–¡ Equipo entrenado en proceso
# â–¡ Contactos de emergencia definidos
# â–¡ Runbook actualizado
# 
# ============================================================================
