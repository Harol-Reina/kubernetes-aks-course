# ============================================================================
# etcd CLUSTER EN ALTA DISPONIBILIDAD
# ============================================================================
# ConfiguraciÃ³n de etcd cluster externo con 3 nodos
# ============================================================================

# ğŸ”§ IMPORTANTE - PRODUCCIÃ“N / CONCEPTUAL EN MINIKUBE:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Este archivo es para APRENDIZAJE de conceptos de etcd en HA.
# 
# âŒ NO SE PUEDE EJECUTAR EN MINIKUBE porque:
# â€¢ Minikube tiene solo 1 nodo etcd (no cluster)
# â€¢ etcd corre como contenedor integrado, no como cluster externo
# â€¢ No se puede configurar un cluster RAFT de 3 nodos
# 
# âœ… CONCEPTOS CLAVE A APRENDER:
# â€¢ Algoritmo de consenso RAFT
# â€¢ Quorum: (N-1)/2 (3 nodos toleran 1 fallo)
# â€¢ ComunicaciÃ³n peer-to-peer (puerto 2380)
# â€¢ ComunicaciÃ³n cliente (puerto 2379)
# â€¢ Leader election
# 
# En Minikube, para trabajar con etcd:
# $ kubectl get pod -n kube-system etcd-minikube
# $ minikube ssh
# $ docker exec -it $(docker ps -q -f "name=k8s_etcd") sh
# $ etcdctl member list
# 
# El CronJob de backup al final puede adaptarse para Minikube
# (ver Lab 02 para procedimiento completo)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

---
# ============================================================================
# ARQUITECTURA etcd CLUSTER
# ============================================================================

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                    etcd CLUSTER                              â”‚
# â”‚                  (RAFT Consensus)                            â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚                                                              â”‚
# â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
# â”‚  â”‚   etcd-1    â”‚   â”‚   etcd-2    â”‚   â”‚   etcd-3    â”‚       â”‚
# â”‚  â”‚  (LEADER)   â”‚â—„â”€â”€â”¤  (FOLLOWER) â”‚â—„â”€â”€â”¤  (FOLLOWER) â”‚       â”‚
# â”‚  â”‚             â”‚â”€â”€â–ºâ”‚             â”‚â”€â”€â–ºâ”‚             â”‚       â”‚
# â”‚  â”‚ :2379       â”‚   â”‚ :2379       â”‚   â”‚ :2379       â”‚       â”‚
# â”‚  â”‚ :2380       â”‚   â”‚ :2380       â”‚   â”‚ :2380       â”‚       â”‚
# â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
# â”‚       â†‘                 â†‘                 â†‘                 â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#         â”‚                 â”‚                 â”‚
#         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                           â”‚
#                  Client connections
#             (API Server, etcdctl, etc.)

# Puertos:
# â€¢ 2379: Client connections (API Server se conecta aquÃ­)
# â€¢ 2380: Peer connections (comunicaciÃ³n entre nodos etcd)

---
# ============================================================================
# INSTALACIÃ“N DE etcd EN CADA NODO
# ============================================================================

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Pasos para instalar etcd en cada nodo
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
# 1. Descargar etcd:
#    $ ETCD_VERSION="v3.5.10"
#    $ wget https://github.com/etcd-io/etcd/releases/download/${ETCD_VERSION}/etcd-${ETCD_VERSION}-linux-amd64.tar.gz
#    $ tar xzf etcd-${ETCD_VERSION}-linux-amd64.tar.gz
#    $ sudo mv etcd-${ETCD_VERSION}-linux-amd64/etcd* /usr/local/bin/
#
# 2. Crear directorios:
#    $ sudo mkdir -p /var/lib/etcd /etc/etcd
#
# 3. Generar certificados TLS (usando cfssl o kubeadm)
#
# 4. Crear archivo systemd service en /etc/systemd/system/etcd.service
#    con la configuraciÃ³n de etcd cluster (ver documentaciÃ³n oficial)
#
#    ParÃ¡metros clave:
#    - name: etcd-1 (Ãºnico por nodo)
#    - listen-client-urls: https://192.168.1.20:2379
#    - listen-peer-urls: https://192.168.1.20:2380
#    - initial-cluster: lista de todos los miembros
#    - initial-cluster-state: new (primera vez) o existing
#    - certificados TLS para client y peer
#
# 5. Iniciar servicio:
#    $ sudo systemctl daemon-reload
#    $ sudo systemctl enable etcd
#    $ sudo systemctl start etcd

# 6. Verificar
# $ sudo systemctl status etcd
# $ sudo journalctl -u etcd -f

---
# ============================================================================
# CONFIGURACIÃ“N PARA etcd-2 y etcd-3
# ============================================================================

# Repetir los pasos anteriores en:
# â€¢ etcd-2 (192.168.1.21): cambiar --name=etcd-2, IPs, etc.
# â€¢ etcd-3 (192.168.1.22): cambiar --name=etcd-3, IPs, etc.

# IMPORTANTE: 
# â€¢ --initial-cluster DEBE ser IGUAL en todos los nodos
# â€¢ --initial-cluster-state=new solo la primera vez
# â€¢ Todos los nodos deben iniciar casi al mismo tiempo

---
# ============================================================================
# VERIFICAR CLUSTER etcd
# ============================================================================

# Ver miembros del cluster
# $ ETCDCTL_API=3 etcdctl \
#   --endpoints=https://192.168.1.20:2379,https://192.168.1.21:2379,https://192.168.1.22:2379 \
#   --cacert=/etc/etcd/ca.crt \
#   --cert=/etc/etcd/server.crt \
#   --key=/etc/etcd/server.key \
#   member list

# Output:
# a1b2c3d4, started, etcd-1, https://192.168.1.20:2380, https://192.168.1.20:2379, false
# e5f6g7h8, started, etcd-2, https://192.168.1.21:2380, https://192.168.1.21:2379, false
# i9j0k1l2, started, etcd-3, https://192.168.1.22:2380, https://192.168.1.22:2379, true
#                                                                                  â†‘ LEADER

# Ver salud del cluster
# $ ETCDCTL_API=3 etcdctl endpoint health \
#   --endpoints=https://192.168.1.20:2379,https://192.168.1.21:2379,https://192.168.1.22:2379 \
#   --cacert=/etc/etcd/ca.crt \
#   --cert=/etc/etcd/server.crt \
#   --key=/etc/etcd/server.key

# Output:
# https://192.168.1.20:2379 is healthy: successfully committed proposal: took = 2.3ms
# https://192.168.1.21:2379 is healthy: successfully committed proposal: took = 2.8ms
# https://192.168.1.22:2379 is healthy: successfully committed proposal: took = 2.5ms

# Ver status detallado
# $ ETCDCTL_API=3 etcdctl endpoint status \
#   --endpoints=https://192.168.1.20:2379,https://192.168.1.21:2379,https://192.168.1.22:2379 \
#   --cacert=/etc/etcd/ca.crt \
#   --cert=/etc/etcd/server.crt \
#   --key=/etc/etcd/server.key \
#   --write-out=table

# Output:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚     ENDPOINT         â”‚   ID   â”‚ VERSION â”‚ DB SIZEâ”‚ IS LEADERâ”‚IS LEARNERâ”‚ ERRORS â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚https://192.168.1.20  â”‚ abc123 â”‚  3.5.10 â”‚  25 kB â”‚   false â”‚   false  â”‚        â”‚
# â”‚https://192.168.1.21  â”‚ def456 â”‚  3.5.10 â”‚  25 kB â”‚   false â”‚   false  â”‚        â”‚
# â”‚https://192.168.1.22  â”‚ ghi789 â”‚  3.5.10 â”‚  25 kB â”‚   true  â”‚   false  â”‚        â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

---
# ============================================================================
# BACKUP AUTOMÃTICO DE etcd
# ============================================================================

apiVersion: batch/v1
kind: CronJob
metadata:
  name: etcd-backup
  namespace: kube-system
spec:
  # Ejecutar cada 6 horas
  schedule: "0 */6 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: etcd-backup
            image: registry.k8s.io/etcd:3.5.10-0
            command:
            - /bin/sh
            - -c
            - |
              BACKUP_DIR="/backup"
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_FILE="${BACKUP_DIR}/etcd-snapshot-${TIMESTAMP}.db"
              
              # Crear snapshot
              ETCDCTL_API=3 etcdctl snapshot save ${BACKUP_FILE} \
                --endpoints=https://192.168.1.20:2379 \
                --cacert=/etc/kubernetes/pki/etcd/ca.crt \
                --cert=/etc/kubernetes/pki/etcd/server.crt \
                --key=/etc/kubernetes/pki/etcd/server.key
              
              # Verificar snapshot
              ETCDCTL_API=3 etcdctl snapshot status ${BACKUP_FILE} --write-out=table
              
              # Limpiar backups antiguos (mantener Ãºltimos 7 dÃ­as)
              find ${BACKUP_DIR} -name "etcd-snapshot-*.db" -mtime +7 -delete
              
              echo "Backup completed: ${BACKUP_FILE}"
            
            volumeMounts:
            - name: etcd-certs
              mountPath: /etc/kubernetes/pki/etcd
              readOnly: true
            - name: backup
              mountPath: /backup
          
          volumes:
          - name: etcd-certs
            hostPath:
              path: /etc/kubernetes/pki/etcd
              type: Directory
          - name: backup
            hostPath:
              path: /var/backups/etcd
              type: DirectoryOrCreate
          
          restartPolicy: OnFailure
          hostNetwork: true

---
# ============================================================================
# RESTORE DE etcd DESDE BACKUP
# ============================================================================

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 1: Detener etcd en TODOS los nodos
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# $ sudo systemctl stop etcd

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 2: Backup del data directory actual (por seguridad)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# $ sudo mv /var/lib/etcd /var/lib/etcd.backup

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 3: Restore desde snapshot EN CADA NODO
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# En etcd-1:
# $ sudo ETCDCTL_API=3 etcdctl snapshot restore /backup/etcd-snapshot-20241111_100000.db \
#   --name=etcd-1 \
#   --initial-cluster=etcd-1=https://192.168.1.20:2380,etcd-2=https://192.168.1.21:2380,etcd-3=https://192.168.1.22:2380 \
#   --initial-cluster-token=etcd-cluster-1 \
#   --initial-advertise-peer-urls=https://192.168.1.20:2380 \
#   --data-dir=/var/lib/etcd

# En etcd-2:
# $ sudo ETCDCTL_API=3 etcdctl snapshot restore /backup/etcd-snapshot-20241111_100000.db \
#   --name=etcd-2 \
#   --initial-cluster=etcd-1=https://192.168.1.20:2380,etcd-2=https://192.168.1.21:2380,etcd-3=https://192.168.1.22:2380 \
#   --initial-cluster-token=etcd-cluster-1 \
#   --initial-advertise-peer-urls=https://192.168.1.21:2380 \
#   --data-dir=/var/lib/etcd

# En etcd-3:
# $ sudo ETCDCTL_API=3 etcdctl snapshot restore /backup/etcd-snapshot-20241111_100000.db \
#   --name=etcd-3 \
#   --initial-cluster=etcd-1=https://192.168.1.20:2380,etcd-2=https://192.168.1.21:2380,etcd-3=https://192.168.1.22:2380 \
#   --initial-cluster-token=etcd-cluster-1 \
#   --initial-advertise-peer-urls=https://192.168.1.22:2380 \
#   --data-dir=/var/lib/etcd

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 4: Ajustar permisos
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# $ sudo chown -R etcd:etcd /var/lib/etcd

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 5: Iniciar etcd en TODOS los nodos
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# $ sudo systemctl start etcd

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 6: Verificar cluster restaurado
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# $ ETCDCTL_API=3 etcdctl member list
# $ kubectl get pods --all-namespaces

---
# ============================================================================
# AGREGAR NUEVO MIEMBRO AL CLUSTER
# ============================================================================

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 1: Agregar miembro desde un nodo existente
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# $ ETCDCTL_API=3 etcdctl member add etcd-4 \
#   --peer-urls=https://192.168.1.23:2380 \
#   --endpoints=https://192.168.1.20:2379 \
#   --cacert=/etc/etcd/ca.crt \
#   --cert=/etc/etcd/server.crt \
#   --key=/etc/etcd/server.key

# Output:
# Member abc123def456 added to cluster xyz789
# 
# ETCD_NAME="etcd-4"
# ETCD_INITIAL_CLUSTER="etcd-1=https://192.168.1.20:2380,etcd-2=https://192.168.1.21:2380,etcd-3=https://192.168.1.22:2380,etcd-4=https://192.168.1.23:2380"
# ETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.1.23:2380"
# ETCD_INITIAL_CLUSTER_STATE="existing"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 2: Configurar nuevo nodo (etcd-4)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Usar configuraciÃ³n del output anterior
# IMPORTANTE: --initial-cluster-state=existing (NO "new")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 3: Iniciar etcd-4
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# $ sudo systemctl start etcd

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 4: Verificar
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# $ ETCDCTL_API=3 etcdctl member list

---
# ============================================================================
# ELIMINAR MIEMBRO DEL CLUSTER
# ============================================================================

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 1: Listar miembros y obtener ID
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# $ ETCDCTL_API=3 etcdctl member list
# a1b2c3d4, started, etcd-1, https://192.168.1.20:2380, ...
# e5f6g7h8, started, etcd-2, https://192.168.1.21:2380, ...
# i9j0k1l2, started, etcd-3, https://192.168.1.22:2380, ...

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 2: Eliminar miembro (ejemplo: etcd-3)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# $ ETCDCTL_API=3 etcdctl member remove i9j0k1l2 \
#   --endpoints=https://192.168.1.20:2379 \
#   --cacert=/etc/etcd/ca.crt \
#   --cert=/etc/etcd/server.crt \
#   --key=/etc/etcd/server.key

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PASO 3: Detener etcd en el nodo eliminado
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# $ sudo systemctl stop etcd

---
# ============================================================================
# NOTAS IMPORTANTES
# ============================================================================
# 
# âœ“ etcd usa RAFT consensus (un lÃ­der, mÃºltiples followers)
# âœ“ Quorum = (N + 1) / 2 nodos deben estar UP
# âœ“ 3 nodos: tolera 1 fallo (quorum = 2)
# âœ“ 5 nodos: tolera 2 fallos (quorum = 3)
# âœ“ NÃºmero IMPAR de nodos SIEMPRE (evita split-brain)
# âœ“ Snapshot NO detiene etcd (operaciÃ³n online)
# âœ“ Restore REQUIERE detener cluster completo
# âœ“ Agregar miembro: --initial-cluster-state=existing
# âœ“ TLS es OBLIGATORIO en producciÃ³n
# âœ“ Backup automÃ¡tico es CRÃTICO (cada 6 horas mÃ­nimo)
# âœ“ Latencia de red entre nodos debe ser < 10ms
# âœ“ DB size grande (>8GB) afecta performance (compactar)
# 
# COMPACTACIÃ“N:
# $ ETCDCTL_API=3 etcdctl compact <revision>
# $ ETCDCTL_API=3 etcdctl defrag --cluster
# 
# MONITOREO:
# â€¢ Ver DB size: etcdctl endpoint status
# â€¢ Ver latency: Prometheus metrics en :2379/metrics
# â€¢ Alertas: DB size > 2GB, latency > 100ms
# 
# ============================================================================
