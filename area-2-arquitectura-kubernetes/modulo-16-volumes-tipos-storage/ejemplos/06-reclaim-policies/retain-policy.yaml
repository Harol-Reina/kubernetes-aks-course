# Reclaim Policy: Retain
# Proteger datos al eliminar PVC - Volumen NO se elimina automÃ¡ticamente

# StorageClass con polÃ­tica Retain
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: azure-disk-retain
  labels:
    policy: retain
provisioner: disk.csi.azure.com
parameters:
  skuname: StandardSSD_LRS
  kind: Managed
reclaimPolicy: Retain  # â† Proteger datos
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true

---
# PVC usando StorageClass con Retain
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-important-data
  labels:
    criticality: high
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: azure-disk-retain
  resources:
    requests:
      storage: 20Gi

---
# Pod que escribe datos importantes
apiVersion: v1
kind: Pod
metadata:
  name: data-producer
  labels:
    app: important-app
spec:
  containers:
  - name: producer
    image: busybox
    command:
    - sh
    - -c
    - |
      echo "=== Escribiendo datos importantes con Retain policy ==="
      echo ""
      
      # Simular datos crÃ­ticos
      echo "=== Datos de producciÃ³n ===" > /data/production-data.txt
      echo "Timestamp inicio: $(date)" >> /data/production-data.txt
      
      # Base de datos simulada
      mkdir -p /data/database
      for i in $(seq 1 1000); do
        echo "Transaction $i: $(date +%s) - Amount: $((RANDOM % 10000))" >> /data/database/transactions.log
      done
      
      # Archivos de configuraciÃ³n
      cat > /data/config.ini <<EOF
      [production]
      database_host=db.example.com
      database_name=proddb
      api_key=super-secret-key-12345
      EOF
      
      echo ""
      echo "=== Datos escritos ==="
      ls -lh /data/
      echo ""
      echo "TamaÃ±o total:"
      du -sh /data
      
      echo ""
      echo "âœ… Datos crÃ­ticos almacenados"
      echo "âš ï¸  Con polÃ­tica Retain, estos datos NO se eliminarÃ¡n al borrar el PVC"
      
      sleep 3600
    
    volumeMounts:
    - name: important-storage
      mountPath: /data
    
    resources:
      requests:
        memory: "128Mi"
        cpu: "200m"
      limits:
        memory: "256Mi"
        cpu: "500m"
  
  volumes:
  - name: important-storage
    persistentVolumeClaim:
      claimName: pvc-important-data

# Flujo con Retain Policy:
#
# 1. Crear PVC â†’ Kubernetes crea PV automÃ¡ticamente
# 2. Pod escribe datos en el volumen
# 3. Eliminar Pod (datos siguen en PV)
# 4. Eliminar PVC â†’ PV pasa a estado "Released" (NO se elimina)
# 5. Disco de Azure sigue existiendo con todos los datos
#
# Estado del PV despuÃ©s de eliminar PVC:
# - Status: Released (ya no estÃ¡ Bound)
# - Datos: Intactos en el disco de Azure
# - No puede ser reclamado automÃ¡ticamente por otro PVC
#
# Â¿CÃ³mo recuperar los datos?
# 1. Obtener URI del disco Azure del PV
# 2. Crear nuevo PV apuntando al mismo disco
# 3. Crear nuevo PVC que se vincule al PV
# 4. Montar en Pod â†’ datos recuperados

# Para probar el ciclo completo:
#
# 1. Crear recursos:
# kubectl apply -f retain-policy.yaml
#
# 2. Verificar PVC y PV creados:
# kubectl get pvc pvc-important-data
# # STATUS: Bound
# PV_NAME=$(kubectl get pvc pvc-important-data -o jsonpath='{.spec.volumeName}')
# echo "PV creado: $PV_NAME"
# kubectl get pv $PV_NAME
# # RECLAIM POLICY: Retain âœ…
#
# 3. Ver logs del Pod:
# kubectl logs data-producer
# # Debe mostrar "Datos crÃ­ticos almacenados"
#
# 4. Verificar datos escritos:
# kubectl exec data-producer -- ls -lh /data/
# kubectl exec data-producer -- cat /data/production-data.txt
#
# 5. Eliminar Pod (datos siguen en PV):
# kubectl delete pod data-producer
# kubectl get pv $PV_NAME
# # STATUS: Bound (PVC sigue existiendo)
#
# 6. âš ï¸ PASO CRÃTICO: Eliminar PVC
# kubectl delete pvc pvc-important-data
# kubectl get pv $PV_NAME
# # STATUS: Released â† PV sigue existiendo
# # RECLAIM POLICY: Retain
#
# 7. Verificar que el disco de Azure NO se eliminÃ³:
# kubectl describe pv $PV_NAME | grep "VolumeHandle"
# # Copiar el URI del disco
#
# 8. Intentar crear nuevo PVC (NO se vincularÃ¡ automÃ¡ticamente):
# kubectl apply -f - <<EOF
# apiVersion: v1
# kind: PersistentVolumeClaim
# metadata:
#   name: pvc-recover-data
# spec:
#   accessModes:
#     - ReadWriteOnce
#   storageClassName: azure-disk-retain
#   resources:
#     requests:
#       storage: 20Gi
# EOF
# kubectl get pvc pvc-recover-data
# # STATUS: Pending â† No puede vincular al PV Released
#
# 9. Recuperar datos manualmente:
# # OpciÃ³n A: Limpiar claimRef del PV
# kubectl patch pv $PV_NAME -p '{"spec":{"claimRef":null}}'
# kubectl get pv $PV_NAME
# # STATUS: Available â† Ahora puede ser reclamado
# kubectl get pvc pvc-recover-data
# # STATUS: Bound â† Se vincula automÃ¡ticamente
#
# # OpciÃ³n B: Crear nuevo PV apuntando al mismo disco
# # (Ver ejemplo en pv-migration.yaml)
#
# 10. Crear Pod para verificar datos recuperados:
# kubectl run data-recovery --image=busybox --rm -it --restart=Never \
#   --overrides='
# {
#   "spec": {
#     "containers": [{
#       "name": "recovery",
#       "image": "busybox",
#       "command": ["sh", "-c", "ls -lh /data/ && cat /data/production-data.txt && cat /data/config.ini"],
#       "volumeMounts": [{
#         "name": "recovered-storage",
#         "mountPath": "/data"
#       }]
#     }],
#     "volumes": [{
#       "name": "recovered-storage",
#       "persistentVolumeClaim": {
#         "claimName": "pvc-recover-data"
#       }
#     }]
#   }
# }'
# # âœ… Debe mostrar todos los datos originales
#
# 11. Limpiar completamente:
# kubectl delete pvc pvc-recover-data
# kubectl delete pv $PV_NAME
# kubectl delete storageclass azure-disk-retain
# # El disco de Azure debe eliminarse manualmente si es necesario

# Ventajas de Retain:
# âœ… ProtecciÃ³n contra eliminaciÃ³n accidental
# âœ… RecuperaciÃ³n de desastres
# âœ… AuditorÃ­a y cumplimiento (datos persisten)
# âœ… MigraciÃ³n de datos entre clusters
#
# Desventajas:
# âŒ Requiere gestiÃ³n manual de recursos
# âŒ PV queda en estado Released (no reutilizable automÃ¡ticamente)
# âŒ Discos "huÃ©rfanos" si no se limpian
# ðŸ’° Costos: discos siguen facturÃ¡ndose

# Â¿CuÃ¡ndo usar Retain?
# âœ… Bases de datos de producciÃ³n
# âœ… Datos crÃ­ticos de negocio
# âœ… Entornos regulados (compliance)
# âœ… Datos que requieren respaldo manual
# âŒ Entornos de desarrollo/testing
# âŒ Datos temporales o fÃ¡cilmente reconstruibles
