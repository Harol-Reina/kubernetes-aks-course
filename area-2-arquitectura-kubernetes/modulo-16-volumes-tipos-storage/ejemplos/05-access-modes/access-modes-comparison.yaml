# ComparaciÃ³n de Access Modes en Azure AKS
# Tabla de compatibilidad: StorageClass vs Access Mode

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ StorageClass            â”‚ ReadWriteOnce   â”‚ ReadOnlyMany   â”‚ ReadWriteMany   â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ managed-csi             â”‚ âœ… SÃ­           â”‚ âŒ No          â”‚ âŒ No           â”‚
# â”‚ (Azure Disk Standard)   â”‚                 â”‚                â”‚                 â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ managed-csi-premium     â”‚ âœ… SÃ­           â”‚ âŒ No          â”‚ âŒ No           â”‚
# â”‚ (Azure Disk Premium)    â”‚                 â”‚                â”‚                 â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ azurefile-csi           â”‚ âœ… SÃ­           â”‚ âœ… SÃ­          â”‚ âœ… SÃ­           â”‚
# â”‚ (Azure Files Standard)  â”‚                 â”‚                â”‚                 â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ azurefile-csi-premium   â”‚ âœ… SÃ­           â”‚ âœ… SÃ­          â”‚ âœ… SÃ­           â”‚
# â”‚ (Azure Files Premium)   â”‚                 â”‚                â”‚                 â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# Test Suite: Probar todos los modos

---
# Test 1: RWO con Azure Disk (managed-csi) - âœ… Debe funcionar
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test-rwo-disk
  labels:
    test: access-modes
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: managed-csi
  resources:
    requests:
      storage: 5Gi

---
# Test 2: RWX con Azure Disk - âŒ Debe FALLAR
# Azure Disk NO soporta ReadWriteMany
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test-rwx-disk-fail
  labels:
    test: access-modes
spec:
  accessModes:
    - ReadWriteMany  # âŒ No soportado por Azure Disk
  storageClassName: managed-csi
  resources:
    requests:
      storage: 5Gi
# Resultado esperado: PVC queda en Pending
# Error: "storageclass.storage.k8s.io 'managed-csi' not found or does not support ReadWriteMany"

---
# Test 3: RWX con Azure Files - âœ… Debe funcionar
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test-rwx-files
  labels:
    test: access-modes
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: azurefile-csi
  resources:
    requests:
      storage: 10Gi

---
# Test 4: ROX con Azure Files - âœ… Debe funcionar
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test-rox-files
  labels:
    test: access-modes
spec:
  accessModes:
    - ReadOnlyMany
  storageClassName: azurefile-csi
  resources:
    requests:
      storage: 10Gi

---
# Pod de prueba para RWO
apiVersion: v1
kind: Pod
metadata:
  name: test-pod-rwo
  labels:
    test: access-modes
spec:
  containers:
  - name: tester
    image: busybox
    command: ["sh", "-c", "echo 'RWO Test: Writing' > /data/test.txt && sleep 3600"]
    volumeMounts:
    - name: storage
      mountPath: /data
    resources:
      requests:
        memory: "64Mi"
        cpu: "100m"
      limits:
        memory: "128Mi"
        cpu: "200m"
  volumes:
  - name: storage
    persistentVolumeClaim:
      claimName: test-rwo-disk

---
# Deployment de prueba para RWX (mÃºltiples Pods)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-deployment-rwx
  labels:
    test: access-modes
spec:
  replicas: 3
  selector:
    matchLabels:
      app: test-rwx
  template:
    metadata:
      labels:
        app: test-rwx
    spec:
      containers:
      - name: tester
        image: busybox
        command:
        - sh
        - -c
        - |
          echo "Pod $(hostname) escribiendo en RWX"
          echo "Pod: $(hostname) - Timestamp: $(date)" >> /data/test-rwx.txt
          sleep 3600
        volumeMounts:
        - name: shared-storage
          mountPath: /data
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"
      volumes:
      - name: shared-storage
        persistentVolumeClaim:
          claimName: test-rwx-files

# Matriz de decisiÃ³n: Â¿QuÃ© Access Mode usar?
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Caso de Uso                            â”‚ Access Mode Recomendado     â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ Base de datos (PostgreSQL, MySQL)      â”‚ RWO (managed-csi)           â”‚
# â”‚ - Una sola instancia                   â”‚                             â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ AplicaciÃ³n stateful (1 rÃ©plica)        â”‚ RWO (managed-csi)           â”‚
# â”‚ - GitLab, Jenkins, etc.                â”‚                             â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ WordPress con mÃºltiples rÃ©plicas       â”‚ RWX (azurefile-csi)         â”‚
# â”‚ - Compartir directorio uploads/        â”‚                             â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ CMS con media compartido               â”‚ RWX (azurefile-csi)         â”‚
# â”‚ - Drupal, Joomla                       â”‚                             â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ Procesamiento de archivos distribuido â”‚ RWX (azurefile-csi)         â”‚
# â”‚ - MÃºltiples workers                    â”‚                             â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ Configuraciones estÃ¡ticas              â”‚ ROX (azurefile-csi)         â”‚
# â”‚ - Datos de referencia                  â”‚ o ConfigMap/Secret          â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ Machine Learning: modelos entrenados   â”‚ ROX (azurefile-csi)         â”‚
# â”‚ - Distribuir a inference pods          â”‚                             â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ Logs centralizados escritos por todos â”‚ RWX (azurefile-csi)         â”‚
# â”‚ - MÃºltiples Pods escribiendo           â”‚                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# Consideraciones de rendimiento:
#
# Azure Disk (RWO):
# âœ… Alto rendimiento (hasta 20,000 IOPS Premium)
# âœ… Baja latencia
# âœ… Ideal para bases de datos
# âŒ Solo un nodo puede montar
# ğŸ’° Costo moderado
#
# Azure Files (RWX/ROX):
# âœ… MÃºltiples nodos pueden montar
# âœ… Flexible para aplicaciones distribuidas
# âš ï¸  Rendimiento moderado (hasta 100,000 IOPS Premium)
# âš ï¸  Mayor latencia que Disk
# ğŸ’° Costo mÃ¡s alto

# Para probar la suite completa:
#
# Aplicar todos los tests:
# kubectl apply -f access-modes-comparison.yaml
#
# Ver estado de PVCs:
# kubectl get pvc -l test=access-modes
# # test-rwo-disk:        âœ… Bound
# # test-rwx-disk-fail:   âŒ Pending (esperado)
# # test-rwx-files:       âœ… Bound
# # test-rox-files:       âœ… Bound
#
# Ver error del PVC que debe fallar:
# kubectl describe pvc test-rwx-disk-fail
# # Events: "storageclass does not support ReadWriteMany"
#
# Ver Pod RWO:
# kubectl get pod test-pod-rwo
# kubectl exec test-pod-rwo -- cat /data/test.txt
#
# Ver Deployment RWX:
# kubectl get pods -l app=test-rwx -o wide
# # 3 Pods, posiblemente en diferentes nodos
# kubectl exec -l app=test-rwx -- cat /data/test-rwx.txt
# # Debe mostrar entradas de los 3 Pods
#
# Limpiar:
# kubectl delete -f access-modes-comparison.yaml
