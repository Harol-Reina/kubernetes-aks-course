#---------------------------------------------------------------------
# HAProxy Configuration for Kubernetes HA Control Plane
#---------------------------------------------------------------------
# Propósito: Load Balancer para múltiples API Servers de Kubernetes
# Uso: Copiar a /etc/haproxy/haproxy.cfg en el nodo Load Balancer
# Requisitos: HAProxy 2.4+
#
# IMPORTANTE: Actualizar IPs de los control planes antes de usar
#---------------------------------------------------------------------

#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    # Logging configuration
    log /dev/log    local0
    log /dev/log    local1 notice
    
    # Security: Run HAProxy in a chroot jail
    chroot /var/lib/haproxy
    
    # Stats socket for runtime API
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    
    # User and group
    user haproxy
    group haproxy
    
    # Run as daemon
    daemon

    # Default SSL material locations
    ca-base /etc/ssl/certs
    crt-base /etc/ssl/private

    # Modern SSL configuration (compatible with Kubernetes)
    # Based on Mozilla SSL Configuration Generator
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

    # Tuning
    maxconn 4096
    tune.ssl.default-dh-param 2048

#---------------------------------------------------------------------
# Common defaults that all the 'listen' and 'backend' sections will
# use if not designated in their block
#---------------------------------------------------------------------
defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    
    # Timeouts
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    
    # Error files
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

#---------------------------------------------------------------------
# Kubernetes API Server - Frontend
#---------------------------------------------------------------------
# Este frontend escucha en el puerto 6443 y redirige todo el tráfico
# al backend con los API Servers de los control planes
#---------------------------------------------------------------------
frontend kubernetes-apiserver
    # Bind to all interfaces on port 6443 (Kubernetes API Server port)
    bind *:6443
    
    # Use TCP mode (layer 4) - required for HTTPS/TLS passthrough
    mode tcp
    
    # Enable TCP logging
    option tcplog
    
    # Set default backend
    default_backend kubernetes-apiserver

#---------------------------------------------------------------------
# Kubernetes API Server - Backend
#---------------------------------------------------------------------
# Backend con los tres control planes
# IMPORTANTE: Actualizar IPs según tu infraestructura
#---------------------------------------------------------------------
backend kubernetes-apiserver
    # Use TCP mode
    mode tcp
    
    # Load balancing algorithm
    # roundrobin: Distribuye requests equitativamente
    # Alternativas: leastconn (menos conexiones), source (IP-based)
    balance roundrobin
    
    # Enable TCP health checks
    option tcp-check
    
    # Health check configuration
    # Verifica que el API Server esté respondiendo
    option log-health-checks
    
    # Server entries
    # Formato: server <name> <ip>:<port> <options>
    #
    # Options explicadas:
    # - check: Habilita health checks
    # - fall 3: Marca como down después de 3 checks fallidos consecutivos
    # - rise 2: Marca como up después de 2 checks exitosos consecutivos
    # - inter 2000ms: Intervalo entre health checks (2 segundos)
    # - maxconn 100: Máximo de conexiones concurrentes por servidor
    
    # ⚠️ ACTUALIZAR ESTAS IPs CON TUS CONTROL PLANES ⚠️
    server master-01 192.168.1.101:6443 check fall 3 rise 2 inter 2000ms maxconn 100
    server master-02 192.168.1.102:6443 check fall 3 rise 2 inter 2000ms maxconn 100
    server master-03 192.168.1.103:6443 check fall 3 rise 2 inter 2000ms maxconn 100
    
    # Notas sobre configuración de servidores:
    # - Si tienes solo 2 control planes, comenta la línea master-03
    # - Si tienes 5 control planes, agrega master-04 y master-05
    # - Asegúrate de que las IPs sean alcanzables desde este nodo
    # - El puerto 6443 es el puerto estándar del Kubernetes API Server

#---------------------------------------------------------------------
# HAProxy Statistics - Frontend (Opcional pero recomendado)
#---------------------------------------------------------------------
# Interfaz web para monitorear el estado del Load Balancer
# Acceso: http://<LB_IP>:9090
#---------------------------------------------------------------------
listen stats
    # Bind to port 9090
    bind *:9090
    
    # Use HTTP mode for stats
    mode http
    
    # Enable stats
    stats enable
    
    # Stats URI (página principal)
    stats uri /
    
    # Stats realm (mensaje en autenticación)
    stats realm HAProxy\ Statistics
    
    # Authentication credentials
    # ⚠️ CAMBIAR EN PRODUCCIÓN ⚠️
    # Formato: stats auth <username>:<password>
    stats auth admin:admin
    
    # Refresh interval (30 segundos)
    stats refresh 30s
    
    # Show node name in stats
    stats show-node
    
    # Enable stats admin (permite deshabilitar servidores vía UI)
    # ⚠️ Usar con precaución en producción
    stats admin if TRUE

#---------------------------------------------------------------------
# Configuraciones Alternativas (Comentadas)
#---------------------------------------------------------------------

# Si necesitas usar keepalived para VIP (Virtual IP):
# Descomentar y configurar según tu red
#
# frontend kubernetes-apiserver-vip
#     bind 192.168.1.100:6443  # Virtual IP
#     mode tcp
#     option tcplog
#     default_backend kubernetes-apiserver

# Si necesitas SSL/TLS termination en HAProxy (no recomendado para K8s):
# Kubernetes maneja su propio TLS, pero por si acaso:
#
# frontend kubernetes-apiserver-ssl
#     bind *:6443 ssl crt /etc/haproxy/certs/haproxy.pem
#     mode http
#     default_backend kubernetes-apiserver-http
#
# backend kubernetes-apiserver-http
#     mode http
#     balance roundrobin
#     server master-01 192.168.1.101:6443 check
#     server master-02 192.168.1.102:6443 check
#     server master-03 192.168.1.103:6443 check

#---------------------------------------------------------------------
# Monitoreo y Alertas (Avanzado)
#---------------------------------------------------------------------

# Puedes configurar alertas cuando un backend está down:
# Requiere integración con herramientas externas (Prometheus, etc.)
#
# backend kubernetes-apiserver
#     ...
#     # Email alert cuando todos los servidores están down
#     email-alert mailers mymailers
#     email-alert from haproxy@example.com
#     email-alert to ops@example.com
#
# mailers mymailers
#     mailer smtp1 smtp.example.com:587

#---------------------------------------------------------------------
# Notas de Configuración
#---------------------------------------------------------------------
#
# 1. VALIDAR SINTAXIS antes de aplicar:
#    sudo haproxy -c -f /etc/haproxy/haproxy.cfg
#
# 2. APLICAR CAMBIOS:
#    sudo systemctl restart haproxy
#
# 3. VERIFICAR ESTADO:
#    sudo systemctl status haproxy
#    sudo journalctl -u haproxy -f
#
# 4. VERIFICAR PUERTO ESCUCHANDO:
#    sudo netstat -tulpn | grep :6443
#
# 5. ACCEDER A STATS:
#    http://<LB_IP>:9090
#    Usuario: admin
#    Contraseña: admin
#
# 6. LOGS:
#    sudo tail -f /var/log/haproxy.log
#
#---------------------------------------------------------------------
# Troubleshooting
#---------------------------------------------------------------------
#
# Problema: HAProxy no arranca
# Solución: Verificar sintaxis con haproxy -c -f config.cfg
#
# Problema: Puerto 6443 ya en uso
# Solución: sudo lsof -i :6443 (identificar proceso)
#
# Problema: Backends siempre DOWN
# Solución: Verificar conectividad a control planes
#           ping <control-plane-ip>
#           nc -zv <control-plane-ip> 6443
#
# Problema: Health checks fallan
# Solución: Verificar que API Server esté corriendo en control planes
#           kubectl get --raw='/healthz'
#
#---------------------------------------------------------------------
# Referencias
#---------------------------------------------------------------------
#
# - HAProxy Documentation: http://www.haproxy.org/
# - Kubernetes HA Setup: https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/
# - HAProxy TCP Mode: http://cbonte.github.io/haproxy-dconv/2.4/configuration.html#4-mode
#
#---------------------------------------------------------------------

# End of configuration
